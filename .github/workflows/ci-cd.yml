# VervegrandPortal-V2 CI/CD Pipeline - GitHub Actions
name: CI/CD Pipeline

# Pipeline ne zaman Ã§alÄ±ÅŸsÄ±n?
on:
  push:
    branches: [ main, develop ]  # main veya develop branch'e push olunca
  pull_request:
    branches: [ main ]  # Pull request aÃ§Ä±lÄ±nca

# Environment variables (Gizli bilgiler GitHub Secrets'te saklanÄ±r)
env:
  PYTHON_VERSION: '3.11'
  STREAMLIT_PORT: 8501

jobs:
  # ============================================
  # JOB 1: Kod Kalitesi KontrolÃ¼
  # ============================================
  code-quality:
    name: ğŸ” Kod Kalitesi ve Lint
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Kodu Ä°ndir
      uses: actions/checkout@v4
    
    - name: ğŸ Python Kur
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: ğŸ“¦ BaÄŸÄ±mlÄ±lÄ±klarÄ± YÃ¼kle
      run: |
        python -m pip install --upgrade pip
        pip install flake8 black pylint
    
    - name: ğŸ¨ Kod FormatÄ± KontrolÃ¼ (Black)
      run: |
        black --check --diff .
      continue-on-error: true  # Format hatasÄ± varsa devam et ama bildir
    
    - name: ğŸ” Kod Analizi (Flake8)
      run: |
        flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
        flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics
      continue-on-error: true

  # ============================================
  # JOB 2: GÃ¼venlik TaramasÄ±
  # ============================================
  security-scan:
    name: ğŸ”’ GÃ¼venlik TaramasÄ±
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Kodu Ä°ndir
      uses: actions/checkout@v4
    
    - name: ğŸ Python Kur
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: ğŸ” Dependency GÃ¼venlik TaramasÄ±
      run: |
        pip install safety
        pip install -r requirements.txt
        safety check --json || true
    
    - name: ğŸ•µï¸ Secret TaramasÄ± (API Key, Token sÄ±zÄ±ntÄ±sÄ±)
      uses: trufflesecurity/trufflehog@main
      with:
        path: ./
        base: ${{ github.event.repository.default_branch }}
        head: HEAD

  # ============================================
  # JOB 3: Unit Testler
  # ============================================
  unit-tests:
    name: ğŸ§ª Unit Testler
    runs-on: ubuntu-latest
    needs: [code-quality]  # Kod kalitesi kontrolÃ¼nden sonra Ã§alÄ±ÅŸ
    
    steps:
    - name: ğŸ“¥ Kodu Ä°ndir
      uses: actions/checkout@v4
    
    - name: ğŸ Python Kur
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: ğŸ“¦ BaÄŸÄ±mlÄ±lÄ±klarÄ± YÃ¼kle
      run: |
        pip install -r requirements.txt
        pip install pytest pytest-cov pytest-mock
    
    - name: ğŸ§ª Testleri Ã‡alÄ±ÅŸtÄ±r
      run: |
        # Test dosyalarÄ± oluÅŸturulduÄŸunda bu komut Ã§alÄ±ÅŸacak
        pytest tests/ -v --cov=. --cov-report=xml --cov-report=html
      continue-on-error: true  # HenÃ¼z test yok, devam et
    
    - name: ğŸ“Š Test SonuÃ§larÄ±nÄ± YÃ¼kle
      uses: codecov/codecov-action@v4
      with:
        file: ./coverage.xml
        fail_ci_if_error: false
      if: always()

  # ============================================
  # JOB 4: Integration Test (API BaÄŸlantÄ± Testi)
  # ============================================
  integration-tests:
    name: ğŸ”— Entegrasyon Testleri
    runs-on: ubuntu-latest
    needs: [unit-tests]
    
    steps:
    - name: ğŸ“¥ Kodu Ä°ndir
      uses: actions/checkout@v4
    
    - name: ğŸ Python Kur
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: ğŸ“¦ BaÄŸÄ±mlÄ±lÄ±klarÄ± YÃ¼kle
      run: |
        pip install -r requirements.txt
    
    - name: ğŸ”— Shopify API BaÄŸlantÄ± Testi
      env:
        SHOPIFY_STORE: ${{ secrets.SHOPIFY_STORE }}
        SHOPIFY_TOKEN: ${{ secrets.SHOPIFY_ACCESS_TOKEN }}
      run: |
        python -c "
        from connectors.shopify_api import ShopifyAPI
        import os
        
        # Sadece baÄŸlantÄ± testi (gerÃ§ek API Ã§aÄŸrÄ±sÄ± yapmaz)
        store = os.getenv('SHOPIFY_STORE', 'test-store')
        token = os.getenv('SHOPIFY_TOKEN', 'test-token')
        
        try:
            api = ShopifyAPI(store, token)
            print('âœ… ShopifyAPI baÅŸarÄ±yla baÅŸlatÄ±ldÄ±')
        except Exception as e:
            print(f'âŒ Hata: {e}')
        "
      continue-on-error: true

  # ============================================
  # JOB 5: Build & Deploy (Sadece main branch)
  # ============================================
  deploy:
    name: ğŸš€ Deploy (Production)
    runs-on: ubuntu-latest
    needs: [code-quality, security-scan, unit-tests, integration-tests]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
    - name: ğŸ“¥ Kodu Ä°ndir
      uses: actions/checkout@v4
    
    - name: ğŸ Python Kur
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: ğŸ“¦ BaÄŸÄ±mlÄ±lÄ±klarÄ± YÃ¼kle
      run: |
        pip install -r requirements.txt
    
    # SEÃ‡ENEK 1: Streamlit Cloud Deploy
    - name: â˜ï¸ Streamlit Cloud'a Deploy
      run: |
        echo "ğŸš€ Streamlit Cloud otomatik deploy ediyor..."
        echo "URL: https://vervegrand-portal.streamlit.app"
      # Not: Streamlit Cloud GitHub entegrasyonu varsa otomatik deploy eder
    
    # SEÃ‡ENEK 2: Kendi Sunucunuza Deploy (SSH ile)
    # - name: ğŸ–¥ï¸ Sunucuya Deploy (SSH)
    #   uses: appleboy/ssh-action@master
    #   with:
    #     host: ${{ secrets.SERVER_HOST }}
    #     username: ${{ secrets.SERVER_USER }}
    #     key: ${{ secrets.SSH_PRIVATE_KEY }}
    #     script: |
    #       cd /path/to/VervegrandPortal-V2
    #       git pull origin main
    #       pip install -r requirements.txt
    #       pm2 restart streamlit-app
    
    # SEÃ‡ENEK 3: Docker Container Deploy
    # - name: ğŸ³ Docker Build & Push
    #   uses: docker/build-push-action@v5
    #   with:
    #     push: true
    #     tags: vervegrand/portal:latest

  # ============================================
  # JOB 6: Bildirimler
  # ============================================
  notify:
    name: ğŸ“¢ Bildirim GÃ¶nder
    runs-on: ubuntu-latest
    needs: [deploy]
    if: always()  # Deploy baÅŸarÄ±lÄ±/baÅŸarÄ±sÄ±z olsa da bildir
    
    steps:
    - name: ğŸ“§ Email Bildirimi
      if: failure()  # Sadece hata varsa
      run: |
        echo "âŒ CI/CD Pipeline baÅŸarÄ±sÄ±z!"
        echo "Detaylar: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
    
    # Discord/Slack bildirim Ã¶rneÄŸi
    # - name: ğŸ’¬ Discord Bildirimi
    #   uses: sarisia/actions-status-discord@v1
    #   if: always()
    #   with:
    #     webhook: ${{ secrets.DISCORD_WEBHOOK }}
    #     status: ${{ job.status }}
    #     title: "VervegrandPortal Deploy"
    #     description: "Build #${{ github.run_number }} tamamlandÄ±"
